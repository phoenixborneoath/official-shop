<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phoenixborne — Admin Produk</title>

  <style>
    body{font-family:Inter,system-ui,Arial; background:#111; color:#eee; padding:20px;}
    .card{background:#0b0b0b;border:1px solid #222;padding:18px;border-radius:10px;max-width:900px;margin:16px auto;}
    input,button,textarea{padding:8px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#eee;width:100%}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{max-width:160px}
    img.thumb{width:72px;height:72px;object-fit:cover;border-radius:6px;border:1px solid #222}
    .list-item{border:1px solid #222;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;gap:12px;align-items:center}
    .muted{color:#9a9a9a;font-size:0.9rem}
    .actions button{margin-right:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Admin — Phoenixborne Official Shop</h2>

    <div id="auth-area">
      <div id="user-info" style="display:none">
        <div class="muted">Masuk sebagai: <span id="user-email"></span></div>
        <button id="signoutBtn">Logout</button>
      </div>

      <div id="login-form">
        <input id="email" placeholder="Email admin" />
        <input id="password" type="password" placeholder="Password" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="signinBtn">Sign In</button>
          <button id="signupBtn">Sign Up</button>
        </div>
        <div class="muted" style="margin-top:8px">Gunakan akun admin (email yang akan kamu jadikan admin)</div>
      </div>
    </div>

    <hr/>

    <div id="admin-panel" style="display:none">
      <h3>Tambah / Edit Produk</h3>
      <div class="row">
        <div class="col">
          <label>Judul</label>
          <input id="title" placeholder="Nama produk"/>
          <label style="margin-top:8px">Harga (angka, contoh: 199000)</label>
          <input id="price" placeholder="Harga" />
          <label style="margin-top:8px">Slug (unik, contoh: kaos-phoenix-01)</label>
          <input id="slug" placeholder="slug" />
          <label style="margin-top:8px">Deskripsi</label>
          <textarea id="description" rows="3" placeholder="Deskripsi singkat"></textarea>
        </div>

        <div class="col small">
          <label>Foto produk</label>
          <input id="imagefile" type="file" accept="image/*" />
          <div style="margin-top:10px"><img id="preview" class="thumb" src="" alt="" /></div>
          <div style="margin-top:8px">
            <button id="uploadBtn">Upload & Simpan Produk</button>
            <button id="updateBtn" style="display:none">Update Produk</button>
            <button id="clearBtn">Bersihkan</button>
          </div>
        </div>
      </div>

      <hr/>
      <h3>Daftar Produk</h3>
      <div id="productsList" />
    </div>

    <div id="status" class="muted" style="margin-top:12px"></div>

  </div>

  <!-- Firebase v9 modular CDN -->
  <script type="module">
    // TODO: ganti dengan firebaseConfig kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, getDoc, getDocs, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI elems
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const signinBtn = document.getElementById('signinBtn');
    const signupBtn = document.getElementById('signupBtn');
    const signoutBtn = document.getElementById('signoutBtn');
    const userInfo = document.getElementById('user-info');
    const userEmailSpan = document.getElementById('user-email');

    const adminPanel = document.getElementById('admin-panel');
    const status = document.getElementById('status');

    const titleEl = document.getElementById('title');
    const priceEl = document.getElementById('price');
    const slugEl = document.getElementById('slug');
    const descEl = document.getElementById('description');
    const imageFileEl = document.getElementById('imagefile');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('uploadBtn');
    const updateBtn = document.getElementById('updateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const productsList = document.getElementById('productsList');

    let editingId = null;
    let uploadedImageUrl = null;
    let selectedFile = null;

    // Auth handlers
    signupBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pw = passEl.value;
      if (!email || !pw) return alert('Isi email & password');
      try {
        await createUserWithEmailAndPassword(auth, email, pw);
        status.textContent = 'Akun dibuat. Silakan login.';
      } catch (e) { status.textContent = 'Error: ' + e.message; }
    });

    signinBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pw = passEl.value;
      if (!email || !pw) return alert('Isi email & password');
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (e) { status.textContent = 'Login gagal: ' + e.message; }
    });

    signoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, user => {
      if (user) {
        userInfo.style.display = 'block';
        userEmailSpan.textContent = user.email;
        document.getElementById('login-form').style.display = 'none';
        adminPanel.style.display = 'block';
        status.textContent = 'Terkoneksi sebagai ' + user.email;
        listenProducts(); // mulai realtime listener
      } else {
        userInfo.style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
        adminPanel.style.display = 'none';
        status.textContent = 'Belum login';
        productsList.innerHTML = '';
      }
    });

    // file preview
    imageFileEl.addEventListener('change', (ev) => {
      const f = ev.target.files[0];
      selectedFile = f;
      if (!f) { preview.src = ''; return; }
      preview.src = URL.createObjectURL(f);
    });

    clearBtn.addEventListener('click', () => {
      titleEl.value=''; priceEl.value=''; slugEl.value=''; descEl.value=''; imageFileEl.value=''; preview.src='';
      editingId = null; updateBtn.style.display='none'; uploadBtn.style.display='inline-block'; uploadedImageUrl=null;
    });

    // upload & add product
    uploadBtn.addEventListener('click', async () => {
      const title = titleEl.value.trim();
      const price = parseInt(priceEl.value || '0',10);
      const slug = slugEl.value.trim();
      const description = descEl.value.trim();

      if (!title || !price || !slug) return alert('Isi title, price, slug');

      try {
        status.textContent = 'Mengupload...';
        let imageUrl = '';
        if (selectedFile) {
          const fileRef = sRef(storage, `product_images/${Date.now()}_${selectedFile.name}`);
          const snap = await uploadBytes(fileRef, selectedFile);
          imageUrl = await getDownloadURL(snap.ref);
        }

        const docRef = await addDoc(collection(db, 'products'), {
          title, price, slug, description,
          imageUrl,
          createdAt: serverTimestamp()
        });

        status.textContent = 'Produk tersimpan: ' + docRef.id;
        clearBtn.click();
      } catch (e) {
        console.error(e);
        status.textContent = 'Error: ' + e.message;
      }
    });

    // update product
    updateBtn.addEventListener('click', async () => {
      if (!editingId) return;
      const title = titleEl.value.trim();
      const price = parseInt(priceEl.value || '0',10);
      const slug = slugEl.value.trim();
      const description = descEl.value.trim();
      try {
        status.textContent = 'Updating...';
        let imageUrl = uploadedImageUrl || '';
        if (selectedFile) {
          const fileRef = sRef(storage, `product_images/${Date.now()}_${selectedFile.name}`);
          const snap = await uploadBytes(fileRef, selectedFile);
          imageUrl = await getDownloadURL(snap.ref);
        }
        await updateDoc(doc(db, 'products', editingId), { title, price, slug, description, imageUrl, updatedAt: serverTimestamp() });
        status.textContent = 'Terupdate';
        clearBtn.click();
      } catch (e) {
        console.error(e); status.textContent = 'Error: '+e.message;
      }
    });

    // realtime listener: tampilkan semua produk
    function listenProducts() {
      const qCol = collection(db, 'products');
      // onSnapshot realtime
      onSnapshot(qCol, (snap) => {
        productsList.innerHTML = '';
        snap.forEach(docSnap => {
          const p = docSnap.data();
          const id = docSnap.id;
          const el = document.createElement('div');
          el.className = 'list-item';
          el.innerHTML = `
            <img class="thumb" src="${p.imageUrl || '/icons/icon-192.png'}" alt="">
            <div style="flex:1">
              <div style="font-weight:700">${p.title} <span class="muted">(${p.slug})</span></div>
              <div class="muted">Rp ${p.price?.toLocaleString?.() || p.price}</div>
              <div class="muted">${p.description || ''}</div>
            </div>
            <div class="actions">
              <button data-id="${id}" class="editBtn">Edit</button>
              <button data-id="${id}" class="deleteBtn">Hapus</button>
            </div>
          `;
          productsList.appendChild(el);
        });

        // attach events (delegation)
        productsList.querySelectorAll('.editBtn').forEach(b => {
          b.onclick = async (ev) => {
            const id = ev.target.dataset.id;
            const docSnap = await getDoc(doc(db, 'products', id));
            const data = docSnap.data();
            editingId = id;
            titleEl.value = data.title || '';
            priceEl.value = data.price || '';
            slugEl.value = data.slug || '';
            descEl.value = data.description || '';
            uploadedImageUrl = data.imageUrl || null;
            preview.src = data.imageUrl || '';
            updateBtn.style.display='inline-block';
            uploadBtn.style.display='none';
            status.textContent = 'Edit mode';
          };
        });

        productsList.querySelectorAll('.deleteBtn').forEach(b => {
          b.onclick = async (ev) => {
            const id = ev.target.dataset.id;
            if (!confirm('Hapus produk ini?')) return;
            try {
              await deleteDoc(doc(db, 'products', id));
              status.textContent = 'Produk dihapus';
            } catch (e) { status.textContent = 'Error: '+e.message; }
          };
        });

      }, (err) => { console.error(err); status.textContent = 'Listener error: '+err.message; });
    }

  </script>
</body>
</html>
