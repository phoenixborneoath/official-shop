<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Phoenixborne Official Shop</title>
  <style>
    /* sederhana, fokus fungsional */
    body{font-family:Inter,system-ui,-apple-system; background:#0a0a0a; color:#eee; padding:20px;}
    .container{max-width:1000px;margin:0 auto;}
    h1{font-family:Cinzel,serif;letter-spacing:0.06em}
    .row{display:flex;gap:12px;align-items:flex-start;}
    .card{background:#0f0f10;border:1px solid rgba(255,255,255,0.04);padding:14px;border-radius:10px;margin-bottom:14px;}
    input,textarea,select,button{background:#0b0b0b;border:1px solid rgba(255,255,255,0.06);color:#eee;padding:8px;border-radius:8px;}
    .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px;}
    .prod{padding:12px;border-radius:10px;background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid rgba(255,255,255,0.03);}
    .prod img{width:100%;height:140px;object-fit:cover;border-radius:6px;margin-bottom:8px;}
    .muted{color:#999;font-size:0.9rem;}
    label{display:block;margin-bottom:6px;font-size:0.9rem;}
    .inline{display:inline-flex;gap:8px;}
    .danger{background:#3a1a1a;color:#fff;border:none;padding:8px 10px;border-radius:8px;}
    .primary{background:linear-gradient(180deg,#ffd200,#f4b800);border:none;color:#111;padding:8px 10px;border-radius:8px;}
    .small{font-size:0.85rem;padding:6px 8px;}
    .center{text-align:center;}
    #status{margin-top:8px;font-size:0.95rem}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Panel — Phoenixborne Official Shop</h1>
    <p class="muted">Kelola produk: ubah nama, harga, foto, atau hapus produk.</p>

    <div id="auth-card" class="card">
      <div id="auth-forms">
        <label>Email admin</label>
        <input id="email" type="email" placeholder="admin@contoh.com"/>
        <label>Password</label>
        <input id="password" type="password" placeholder="password"/>
        <div style="margin-top:10px" class="inline">
          <button id="btn-signin" class="primary small">Masuk</button>
          <button id="btn-signout" class="small hidden">Keluar</button>
        </div>
        <div id="status" class="muted"></div>
      </div>
    </div>

    <div id="admin-ui" class="hidden">
      <div class="card">
        <h3>Tambah / Edit Produk</h3>
        <form id="product-form">
          <input id="product-id" type="hidden" />
          <label>Judul</label>
          <input id="title" required />
          <label>Harga (angka)</label>
          <input id="price" type="number" required />
          <label>Deskripsi (opsional)</label>
          <textarea id="description" rows="3"></textarea>
          <label>Ganti Foto</label>
          <input id="image-file" type="file" accept="image/*" />
          <div style="margin-top:8px" class="inline">
            <button type="submit" class="primary small">Simpan</button>
            <button type="button" id="btn-reset" class="small">Reset</button>
          </div>
          <div id="form-status" class="muted"></div>
        </form>
      </div>

      <div class="card">
        <h3>Daftar Produk</h3>
        <div id="products" class="products"></div>
      </div>
    </div>
  </div>

  <!-- Firebase v9 modular (CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDocs, onSnapshot, addDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref as sref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // === GANTI KONFIG DISINI DENGAN CONFIG FIREBASE KAMU ===
    const firebaseConfig = {
      apiKey: "PASTE_APIKEY",
      authDomain: "PROJECT.firebaseapp.com",
      projectId: "PROJECT",
      storageBucket: "PROJECT.appspot.com",
      // messagingSenderId: "...",
      appId: "1:...:web:..."
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI elemen
    const authCard = document.getElementById('auth-card');
    const adminUi = document.getElementById('admin-ui');
    const btnSignIn = document.getElementById('btn-signin');
    const btnSignOut = document.getElementById('btn-signout');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const statusEl = document.getElementById('status');

    const productForm = document.getElementById('product-form');
    const titleEl = document.getElementById('title');
    const priceEl = document.getElementById('price');
    const descEl = document.getElementById('description');
    const imageFileEl = document.getElementById('image-file');
    const productsEl = document.getElementById('products');
    const productIdEl = document.getElementById('product-id');
    const formStatus = document.getElementById('form-status');
    const btnReset = document.getElementById('btn-reset');

    // auth handlers
    btnSignIn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value;
      if (!email || !pass) return statusEl.textContent = "Isi email & password.";
      statusEl.textContent = 'Mencoba masuk...';
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        statusEl.textContent = 'Sukses masuk.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Gagal masuk: ' + (err.message || err.code);
      }
    });

    btnSignOut.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        // tampilkan UI admin
        adminUi.classList.remove('hidden');
        btnSignOut.classList.remove('hidden');
        btnSignIn.classList.add('hidden');
        authCard.classList.add('hidden');
        statusEl.textContent = `Masuk sebagai ${user.email}`;
        startProductsListener();
      } else {
        // sembunyikan UI admin
        adminUi.classList.add('hidden');
        btnSignOut.classList.add('hidden');
        btnSignIn.classList.remove('hidden');
        authCard.classList.remove('hidden');
        statusEl.textContent = 'Belum masuk.';
        // bersihkan daftar
        productsEl.innerHTML = '';
      }
    });

    // Firestore realtime listener
    let unsub = null;
    function startProductsListener() {
      const col = collection(db, 'products');
      if (unsub) unsub();
      // realtime updates
      unsub = onSnapshot(col, snapshot => {
        productsEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const p = { id: docSnap.id, ...docSnap.data() };
          renderProductCard(p);
        });
      }, err => {
        console.error('Listen error', err);
      });
    }

    // Render product card
    function renderProductCard(p) {
      const div = document.createElement('div');
      div.className = 'prod';
      div.innerHTML = `
        <img src="${p.imageUrl || '/images/icons/icon-192.png'}" alt="${escapeHtml(p.title)}" onerror="this.src='/images/icons/icon-192.png'"/>
        <strong>${escapeHtml(p.title)}</strong>
        <div class="muted">Rp ${numberWithCommas(p.price || 0)}</div>
        <div style="margin:8px 0">${escapeHtml(p.description || '')}</div>
        <div class="inline">
          <button class="small" data-action="edit" data-id="${p.id}">Edit</button>
          <button class="small" data-action="delete" data-id="${p.id}">Hapus</button>
        </div>
      `;
      productsEl.appendChild(div);

      div.querySelector('[data-action="edit"]').addEventListener('click', () => {
        // isi form dengan data
        productIdEl.value = p.id;
        titleEl.value = p.title || '';
        priceEl.value = p.price || '';
        descEl.value = p.description || '';
        formStatus.textContent = 'Mengedit produk: ' + p.title;
      });

      div.querySelector('[data-action="delete"]').addEventListener('click', async () => {
        if (!confirm('Hapus produk ini?')) return;
        await deleteProduct(p.id, p.imageUrl);
      });
    }

    // Create / Update product
    productForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const id = productIdEl.value || null;
      const title = titleEl.value.trim();
      const price = Number(priceEl.value);
      const desc = descEl.value.trim();
      const file = imageFileEl.files[0];

      if (!title || !price) { formStatus.textContent = 'Isi judul & harga.'; return; }

      formStatus.textContent = 'Menyimpan...';
      try {
        let imageUrl = null;
        if (file) {
          // upload image ke Storage
          const storageRef = sref(storage, `product_images/${Date.now()}_${file.name}`);
          const snap = await uploadBytes(storageRef, file);
          imageUrl = await getDownloadURL(snap.ref);
        }

        if (id) {
          const docRef = doc(db, 'products', id);
          const updateData = { title, price, description: desc };
          if (imageUrl) updateData.imageUrl = imageUrl;
          await updateDoc(docRef, updateData);
          formStatus.textContent = 'Produk diperbarui.';
        } else {
          const colRef = collection(db, 'products');
          const newDoc = { title, price, description: desc, imageUrl: imageUrl || '' , createdAt: Date.now() };
          await addDoc(colRef, newDoc);
          formStatus.textContent = 'Produk dibuat.';
        }
        productForm.reset();
        productIdEl.value = '';
      } catch (err) {
        console.error(err);
        formStatus.textContent = 'Gagal menyimpan: ' + (err.message || err.code);
      }
    });

    btnReset.addEventListener('click', () => {
      productForm.reset();
      productIdEl.value = '';
      formStatus.textContent = '';
    });

    async function deleteProduct(id, imageUrl) {
      try {
        // jika ada image di storage, coba hapus (opsional)
        if (imageUrl && imageUrl.includes('firebasestorage')) {
          try {
            // dapatkan ref dari url
            const path = decodeURIComponent(imageUrl.split('/o/')[1].split('?')[0]);
            const imgRef = sref(storage, path);
            await deleteObject(imgRef);
          } catch (e) {
            console.warn('Gagal hapus image di storage (mungkin sudah dihapus):', e);
          }
        }
        await deleteDoc(doc(db, 'products', id));
        formStatus.textContent = 'Produk dihapus.';
      } catch (err) {
        console.error(err);
        formStatus.textContent = 'Gagal hapus: ' + (err.message || err.code);
      }
    }

    // helper kecil
    function numberWithCommas(x){return x?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") || '0';}
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Jika mau, bisa menampilkan produk awal untuk pengujian (non-realtime),
    // tetapi onSnapshot sudah menangani semua update realtime.
  </script>
</body>
</html>
